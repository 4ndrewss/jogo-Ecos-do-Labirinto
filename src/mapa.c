#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "mapa.h"
#include "screen.h"
#include "jogo.h"

Mapa* criarMapa(int largura, int altura) {
    Mapa* m = (Mapa*) malloc(sizeof(Mapa));
    m->largura = largura;
    m->altura = altura;
    
    m->dados = (char**) malloc(altura * sizeof(char*));
    for(int i = 0; i < altura; i++) {
        m->dados[i] = (char*) malloc((largura + 1) * sizeof(char));
    }
    return m;
}

void destruirMapa(Mapa* m) {
    for(int i = 0; i < m->altura; i++) {
        free(m->dados[i]);
    }
    free(m->dados);
    free(m);
}

void dl(Mapa* m, int linha, const char* desenho) {
    if (linha >= m->altura) return;
    
    memset(m->dados[linha], ' ', m->largura);
    m->dados[linha][m->largura] = '\0';

    int len = strlen(desenho);
    for(int i=0; i<len && i<m->largura; i++) {
        m->dados[linha][i] = desenho[i];
    }
}

void carregarFase(Mapa* m, int fase) {
    for(int i=0; i<m->altura; i++) {
        memset(m->dados[i], '.', m->largura);
        m->dados[i][m->largura] = '\0';
    }

    if (fase == 1) {
        dl(m, 0,  "############################################################################");
        dl(m, 1,  "#S.........................................................................#");
        dl(m, 2,  "##########################################################################.#");
        dl(m, 3,  "#..........................................................................#");
        dl(m, 4,  "#.##########################################################################");
        dl(m, 5,  "#..........................................................................#");
        dl(m, 6,  "##########################################################################.#");
        dl(m, 7,  "#..........................................................................#");
        dl(m, 8,  "#.##########################################################################");
        dl(m, 9,  "#..........................................................................#");
        dl(m, 10, "##########################################################################.#");
        dl(m, 11, "#..........................................................................#");
        dl(m, 12, "#.##########################################################################");
        dl(m, 13, "#..........................................................................#");
        dl(m, 14, "##########################################################################.#");
        dl(m, 15, "#..........................................................................#");
        dl(m, 16, "#.##########################################################################");
        dl(m, 17, "#..........................................................................#");
        dl(m, 18, "##########################################################################.#");
        dl(m, 19, "#G.........................................................................#");
        dl(m, 20, "############################################################################");

    } else if (fase == 2) {
        dl(m, 0,  "############################################################################");
        dl(m, 1,  "#.........#.................................#..............................#");
        dl(m, 2,  "#.#######.#.#########...###################.#.##########################.#.#");
        dl(m, 3,  "#.#.......#.#.......#.S.#.................#.#.#........................#.#.#");
        dl(m, 4,  "#.#.#######.#.#####.#####.###############.#.#.#.######################.#.#.#");
        dl(m, 5,  "#.#.#.......#.....#.......#...............#...#.#....................#.#.#.#");
        dl(m, 6,  "#.#.#.###########.#######.#####################.#.##################.#.#.#.#");
        dl(m, 7,  "#.#.#.#.........#.#.............................#..................#.#.#...#");
        dl(m, 8,  "#.#.#.#.#######.#.#.###########################.##################.#.#.###.#");
        dl(m, 9,  "#...#.#.#.....#.#.#.#.........................#..................#.#.#.#...#");
        dl(m, 10, "#####.#.#.###.#.#.#.#.#######################.##################.#.#.#.#.###");
        dl(m, 11, "#.....#.#.#...#.#.#.#.#.....................#.#..................#...#.#...#");
        dl(m, 12, "#.#####.#.#.###.#.#.#.#.###################.#.#.######################.###.#");
        dl(m, 13, "#.#.....#.#.....#.#.#.#.#.................#.#.#..........................#.#");
        dl(m, 14, "#.#.#####.#######.#.#.#.#################.#.#.##########################.#.#");
        dl(m, 15, "#.#...............#.#...................#.#..............................#.#");
        dl(m, 16, "#.#################.###################.#.################################.#");
        dl(m, 17, "#.................#...................#.#..................................#");
        dl(m, 18, "#################.###################.#.##################################.#");
        dl(m, 19, "#.................#G..................#....................................#");
        dl(m, 20, "############################################################################");

    } else {
        dl(m, 0,  "############################################################################");
        dl(m, 1,  "#........................................................................#G#");
        dl(m, 2,  "#.###################################.####################################.#");
        dl(m, 3,  "#.#.................#...............#.#....................................#");
        dl(m, 4,  "#.#.###############.###############.#.#.####################################");
        dl(m, 5,  "#.#...............#...............#.#.#................................#.#.#");
        dl(m, 6,  "#.#.#####.#######.#.#.###########.#.#.################################.#.#.#");
        dl(m, 7,  "#.#.#...#.#.....#.#.#.#.........#.#.#..................................#.#.#");
        dl(m, 8,  "#.#.#.#.#.#.###.#.#.#.#.#######.#.#.####################################.#.#");
        dl(m, 9,  "#.#.#.#.#.#.#...#...#.#.#.......#.#..................................#.#.#.#");
        dl(m, 10, "#.#.#.#.#.#.#########.#.#######.######################################.#.#.#");
        dl(m, 11, "#...#.#.#.#..........................................................#.....#");
        dl(m, 12, "#####.#.#.#########################.##################################.#####");
        dl(m, 13, "#.....#.#.......................###................................#.......#");
        dl(m, 14, "#.#####.#######################.###.##############################.#.#######");
        dl(m, 15, "#.#...........................#.###..............................#.#.....###");
        dl(m, 16, "#.#.#########################.#.################################.#.#####.###");
        dl(m, 17, "#.#.#............................................................#.......###");
        dl(m, 18, "#.###########################.##############################################");
        dl(m, 19, "#S#...........................#...........................................##");
        dl(m, 20, "############################################################################");
    }
}

void desenharMapa(Mapa* m) {
    screenSetColor(WHITE, BLACK);
    
    for (int i = 0; i < m->altura; i++) {
        screenGotoxy(GAME_MINX, GAME_MINY + i);

        for (int j = 0; j < m->largura; j++) {
            char celula = m->dados[i][j];

            if (celula == '.') {
                printf(" ");
            }
            else if (celula == '#') {
                printf("#");
            }
            else if (celula == 'G') {
                screenSetColor(GREEN, BLACK);  
                printf("‚öê");
                screenSetColor(WHITE, BLACK);
            }
            else if (celula == 'S') {
                screenSetColor(CYAN, BLACK);    
                printf("S");
                screenSetColor(WHITE, BLACK);
            }
            else {
                printf("%c", celula);
            }
        }
    }
}


int verificarColisao(Mapa* m, int x, int y) {
    int mapX = x - GAME_MINX;
    int mapY = y - GAME_MINY;
    
    if (mapX < 0 || mapX >= m->largura || mapY < 0 || mapY >= m->altura) return 1;
    
    char celula = m->dados[mapY][mapX];
    if (celula == '#') return 1; 
    if (celula == 'G') return 2; 
    return 0;
}